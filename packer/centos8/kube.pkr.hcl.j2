# kubernetes runtime configuration

# All generated input variables will be of string type as this how Packer JSON
# views them; you can later on change their type. Read the variables type
# constraints documentation
# https://www.packer.io/docs/from-1.5/variables#type-constraints for more info.
# "timestamp" template function replacement
locals { timestamp = regex_replace(timestamp(), "[- TZ:]", "") }

# source blocks are generated from your builders; a source can be referenced in
# build blocks. A build block runs provisioner and post-processors onto a
# source. Read the documentation for source blocks here:
# https://www.packer.io/docs/from-1.5/blocks/source

#
# Container runtimes
#
source "qemu" "kuberun" {
  accelerator          = "kvm"
  boot_wait            = "5s"
  disk_image           = true
  disk_interface       = "virtio"
  disk_size            = "81920M"
  memory               = 2048
  format               = "qcow2"
  headless             = true
  http_directory       = "http"
  iso_checksum         = "sha256:{{ env('sha256sum') }}"
  iso_url              = "images/centos8.qcow2"
  net_device           = "virtio-net"
  output_directory     = "output"
  shutdown_command     = "/sbin/shutdown -h now"
  ssh_port             = 22
  ssh_username         = "root"
  ssh_password         = "{{ env('password') }}"
  ssh_wait_timeout     = "1800s"
  vm_name              = "kuberun"
}

# a build block invokes sources and runs provisionning steps on them. The
# documentation for build blocks can be found here:
# https://www.packer.io/docs/from-1.5/blocks/build
build {
  sources = ["source.qemu.kuberun"]

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/update.sh"
  }

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/kube_tools.sh"
  }

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/container_runtime.sh"
  }

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/cleanup.sh"
  }
}


#
# Control Plane 
#
source "qemu" "kubemaster" {
  accelerator          = "kvm"
  boot_wait            = "5s"
  disk_image           = true
  disk_interface       = "virtio"
  disk_size            = "81920M"
  memory               = 2048
  format               = "qcow2"
  headless             = true
  http_directory       = "http"
  iso_checksum         = "sha256:{{ env('sha256sum') }}"
  iso_url              = "images/centos8.qcow2"
  net_device           = "virtio-net"
  output_directory     = "output"
  shutdown_command     = "/sbin/shutdown -h now"
  ssh_port             = 22
  ssh_username         = "root"
  ssh_password         = "{{ env('password') }}"
  ssh_wait_timeout     = "1800s"
  vm_name              = "kubemaster"
}

# a build block invokes sources and runs provisionning steps on them. The
# documentation for build blocks can be found here:
# https://www.packer.io/docs/from-1.5/blocks/build
build {
  sources = ["source.qemu.kubemaster"]

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/update.sh"
  }

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/kube_tools.sh"
  }

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/control_plane.sh"
  }

  provisioner "shell" {
    execute_command = "{{ '{{' }}.Vars{{ '}}' }}bash '{{ '{{' }}.Path{{ '}}' }}'"
    script          = "scripts/cleanup.sh"
  }
}